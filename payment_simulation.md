## Payment Simulation

1. **The user makes an order**
**Action**: ``POST /api/orders``
**Input**: 
  ```bash
  {
    "title": "Buy groceries from Shoprite",
    "description": "1kg rice, 2 liters milk, bread",
    "category": "groceries", // groceries, electronics, documents, etc.
    "store_name": "Shoprite Ikeja",
    "store_location": {
      "address": "Shoprite, Allen Avenue, Ikeja, Lagos",
      "latitude": 6.6018,
      "longitude": 3.3515
    },
    "delivery_location": {
      "address": "15 Admiralty Way, Lekki Phase 1, Lagos",
      "latitude": 6.4474,
      "longitude": 3.4706
    },
    "estimated_item_cost": 15000, // in kobo or smallest currency unit
    "reference_photos": [
      "base64_encoded_image_1",
      "base64_encoded_image_2"
    ],
    "special_instructions": "Please get fresh items only",
    "is_urgent": false
  }
  ```

**Core Variables**:
- *user_id* (string) //gotten from the session
- *description* (text)
- *category* (enum)
- *store_name* (string)
- *store_location*
- *delivery_location*
- *estimated_item_cost*

**Optional Variables**
- *reference_photos*
- *special_instructions*
- *is_urgent* - set to false if not given


**Fee Calculation**
- estimated_item_cost: 15,000
- shopper_fee: 1,500 (10%)
- dispatcher_fee: 1,200 (Base + distance)
- platform_fee: 800
- **total_cost**: 18,500
- require a FeeService Module 

**Save to ``order`` table:**
- Add new row to ``orders`` table
- Set ``status`` to ``pending_payment``
- Store payments (estimated, shopper, dispatch) in kobo - 1850000

**Save to ``order_timeline`` table:**
- Using the order_id generated when adding to the previous table
- update the ``order_timeline`` table and set status to ``pending_payment``

**Save to ``files`` table and ``order_reference_photos`` table:***
- Loop through the images and:
- Add entry to the ``files`` table and then the ``order_reference_photos`` using the file_id generated

**System Generated Variable**
- *order_id* (uuid)
- *status* (enum)
- *created_at* (datetime)
- *breakdown [shopper_fee, dispatcher_fee, platform_fee]* generated by FeeService Module
- *payment [payment_status]*


**Response:**
  ```bash
  {
    "success": true,
    "data": {
      "order_id": "ord_456def",
      "status": "pending_shopper",
      "created_at": "2025-10-12T14:30:00Z",
      "estimated_total": 18500, // with fees
      "breakdown": {
        "item_cost": 15000,
        "shopper_fee": 1500,
        "dispatcher_fee": 1200,
        "platform_fee": 800
      }
      "payment": {
        "payment_required": true,
        "payment_id": "string (nullable)",
        "payment_status": "pending"
      }
    }
    "message": "Order created successfully. Please proceed to payment."
  }
  ```



2. **Initialize Payment**
**Actor**: Customer App (User clicks "Pay Now")
**Action**: POST /api/payments/initialize

**Request Body**
  ```bash 
  {
    "order_id": "ord_999",
    "payment_method": "card",
    "gateway_preference": "stripe",
    "idempotency_key": "a1b2c3d4-e5f6-7890" // generated by frontend on clicking "Pay Now"  or loading "Payment Page"
  }
  ```

**My Question:** gateway_preference not included in doc as well as idempotency key - should I include it?

**Backend Simulation:**
- Check ``orders`` table  for ``order_id``
- Does it exist? Yes
- Is the ``order.payment_status`` ==  ``payment_pending``? Yes
- If NO, report error

**Save to ``payment_transactions`` table:**
- Create a new entry
- Then insert
  - *user_id* (get from session or function from auth)
  - *order_id* (from the request body)
  - *customer_email* (use helper function from auth or user)
  - *initiated_at*
  - *amount*
  - *payment_method* e.g. cards, etc.  
  - *idempotency_key*

  Optional
  - *currency* default to NGN
  - *ip_address* Very useful for fraud detection if the payment fails later
  - *gateway_request* you generate the JSON payload you intend to send to the gateway provider

**Save to ``transaction_status_history`` table:**
- Create new entry
- Then insert:
  - *transaction_id*: The UUID you just got from the *payment_transactions* insert.
  - *new_status*: *'pending'*
  - *triggered_by*: 'api'

  Optional
  - *metadata*


**Make an external call to the payment gateway api e.g Paystack, or Stripe**
- Get the following:  ``reference`` and ``authorization_url``
- Then update the following:
  - *gateway_reference* with the ``reference`` returned
  - *gateway_response* save the entire json response body

**Response**
  ```bash
  {
    "success": true,
    "data": {
      "payment_id": "pay_789xyz",
      "amount": 18720,
      "currency": "NGN",
      "payment_method": "string",
      "authorization_url": "https://paystack.com/pay/xyz",
      "reference": "ref_123456"
      "expires_at": "string (ISO 8601)"
    },
     "message": "Payment initialized."
  }
  ```

**3. Webhook Received (The Confirmation)**
*Paystack for example*
  ```bash
  const crypto = require('crypto');
  const secret = process.env.SECRET_KEY;
  // Using Express
  app.post("/my/webhook/url", function(req, res) {
      //validate event
      const hash = crypto.createHmac('sha512', secret).update(JSON.stringify(req.body)).digest('hex');
      if (hash == req.headers['x-paystack-signature']) {
        // Retrieve the request's body
        const event = req.body;
        // Do something with event  
      }
      res.send(200);
  });
  // check https://paystack.com/docs/payments/webhooks/ for more info
  ```

**Request Body**
  ```bash
  {
    "event": "charge.success",
    "data": {
      "id": 302961,
      "domain": "live",
      "status": "success",
      "reference": "qTPrJoy9Bx",
      "amount": 10000,
      "message": null,
      "gateway_response": "Approved by Financial Institution",
      "paid_at": "2016-09-30T21:10:19.000Z",
      "created_at": "2016-09-30T21:09:56.000Z",
      "channel": "card",
      "currency": "NGN",
      "ip_address": "41.242.49.37",
      "metadata": 0,
      "log": {
        "time_spent": 16,
        "attempts": 1,
        "authentication": "pin",
        "errors": 0,
        "success": false,
        "mobile": false,
        "input": [],
        "channel": null,
        "history": [
          {
            "type": "input",
            "message": "Filled these fields: card number, card expiry, card cvv",
            "time": 15
          },
          {
            "type": "action",
            "message": "Attempted to pay",
            "time": 15
          },
          {
            "type": "auth",
            "message": "Authentication Required: pin",
            "time": 16
          }
        ]
      },
      "fees": null,
      "customer": {
        "id": 68324,
        "first_name": "BoJack",
        "last_name": "Horseman",
        "email": "bojack@horseman.com",
        "customer_code": "CUS_qo38as2hpsgk2r0",
        "phone": null,
        "metadata": null,
        "risk_action": "default"
      },
      "authorization": {
        "authorization_code": "AUTH_f5rnfq9p",
        "bin": "539999",
        "last4": "8877",
        "exp_month": "08",
        "exp_year": "2020",
        "card_type": "mastercard DEBIT",
        "bank": "Guaranty Trust Bank",
        "country_code": "NG",
        "brand": "mastercard",
        "account_name": "BoJack Horseman"
      },
      "plan": {}
    }
  }
  ```
